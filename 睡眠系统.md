# 睡眠系统

## 概述

本文档描述了用户注册相关的API接口，包括发送短信验证码、用户注册和用户登录功能。

## 用户模块

### 1. 发送短信验证码

**接口地址:** `POST /api/v1/user/send_sms`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"
}
```

**请求参数:**

```json
{
    "phone": "13800138000",
    "purpose": "register"
}
```

**参数说明:**

- `phone`: 手机号码，必填，11位数字，格式：1[3-9]xxxxxxxxx
- `purpose`: 用途，可选，默认为"login"，可选值：login、set_pwd等

**响应示例:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": "验证码发送成功"
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"发送失败: {str(e)}"}
}
```

### 2. 用户登录（验证码、密码登录）

**接口地址:** `POST /api/v1/user/sms_login`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"
}
```

**请求参数:**

```json
{
    "phone": "13800138000",
    "code": "123456",
    "method": "sms" # 密码登录为: pwd
}
```

**参数说明:**

- `phone`: 手机号码，必填，11位数字
- `code`: 短信验证码，必填，6位数字

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
        "id": 1,
        "phone": "13800138000",
        "user_name": "phone_13800138000",
        "alias": null,
        "avatar_url": null,
        "is_activate": true,
        "user_type": true,
        'birthday': '1990-01-01',
        "age": null,
        "created_at": "2024-01-01T00:00:00",
        "updated_at": "2024-01-01T00:00:00"
    }
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"登录失败: {str(e)}"}
}
```

### 3. 用户注册

**接口地址:** `POST /api/v1/user/sms_register`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"
}
```

**请求参数:**

```json
{
    "phone": "13800138000",
    "code": "123456",
    "password":"1234"
}
```

**参数说明:**

- `phone`: 手机号码，必填，11位数字
- `code`: 短信验证码，必填，6位数字
- `password`: 密码

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
        "id": 1,
        "phone": "13800138000",
        "user_name": "phone_13800138000",
        "is_activate": true,
        "user_type": true,
        "session_id"="xxx",
        "created_at": "2024-01-01T00:00:00",
        "updated_at": "2024-01-01T00:00:00"
    }
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 5. 上传图片接口

**接口地址:** `POST /api/v1/main/upload_avatar`

**请求头**：

```
{
    "Content-Type": "",
    "Accept-Language":"zh-CN"，
}
```

**请求参数:**

```json
{
   file
}
```

**参数说明:**

- `file`:  图片，必须为图片类型

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
       "avatar_url"：/static/images/avatar/xx.png
    }
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 6. 完善个人信息

**接口地址:** `POST /api/v1/user/complete_info`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**请求参数:**

```json
{
  	"avatar_url":"xxx"，
    "alias": "张三",
    "gender":"1",  
    "birthday":"1990-01-01"
}
```

**参数说明:**

- `avatar_url`:  头像地址
- `alias`: 昵称
- `gender`: 性别 、男：1  女：0
- `birthday` : 生日年月日

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
       "Content": "信息完善xx"
    }
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"登录失败: {str(e)}"}
}
```

### 7. 返回视频地址

**接口地址:** `POST /api/v1/system/equipment`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**请求参数:**

```json
{
    
}
```

**参数说明:**



**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {"product_introduce": "https://sleep.pengbrain.com", "tutorial": "https://sleep.pengbrain.com/static/video/4601bb8888d2a7a1cb5bd3ff43493991.mp4"}
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 8. 用户反馈

**接口地址:** `POST /api/v1/user/feedback`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**请求参数:**

```json
{
   "type":"error"，
   "content":"xxx",
   "image_path":["/xxx/sss/img.png","/xxx/sss.png"]
}
```

**参数说明:**

- `type`:  类型
- `content`: 内容
- `image_path`: 图片地址

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
       "Content": "信息完善xx"
    }
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"登录失败: {str(e)}"}
}
```

### 9. 反馈列表（分页）

**接口地址:** `POST /api/v1/system/feedback_record`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language": "zh-CN",
    "X-Session-Id": "0acd0cc7620c4c8d845a1ad1626a5be1"
}
```

**请求参数**

```
{
    "page": 1,
    "page_size":10
}
```

**参数说明**

- `page`：第一页
- `page_size`：每页显示的条数

**响应示例**

```
{
	{
		'code': 200, 
		'msg': 1, 
		'datainfo': {
		'data': 
			[{'id': 2, 
			'created_at': '2025-11-11', 
			'type': 'error', 
			'content': 'xxx', 
			'image_path': "['/xxx/sss/img.png', '/xxx/sss.png']", 
			'user__alias': '张三'}], 
		'total': 1, 
		'page': 1, 
		'page_size': 10, 
		'total_page': 1
		}}
	
  	}
```

**返回值说明**

- `data`：查询的内容
- `type`：反馈类别
- `content`：反馈内容
- `image_path`：反馈图片地址
- `user__alias`: 用户昵称

### 10. 系统更新

**接口地址:** `GET /api/v1/system/update_system`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{
    "version": "1"  # 参数为url请求参数，get请求
}
```

**参数说明:**

+ `version`: 版本号

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {'download': 'https://sleep.pengbrain.com/static/app/version/2.zip', 'md5': 'd41d8cd98f00b204e9800998ecf8427e'}
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 11. 获取个人信息

**接口地址:** `GET /api/v1/user/userinfo`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{

}
```

**参数说明:**

- `version`: 版本号

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {'id': 1, 'phone': '15200802947', 'user_name': 'phone_15200802947', 'alias': '张三', 'avatar_url': '', 'is_activate': None, 'user_type': True, 'age': None, 'gender': '1', 'birthday': '1990-01-10', 'created_at': '2025-11-06T11:36:56.338293+08:00', 'updated_at': '2025-12-03T15:47:41.239713+08:00', 'session_id': 'ee9c61bd79bb47499e55102788d29a9a', 'wechat_openid': None, 'wechat_unionid': None, 'wechat_nickname': None, 'wechat_avatar': None, 'need_bind_phone': False}}

}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

## 

## 睡眠模块

### 1. 生成报告

**接口地址:** `ws wss://sleep.pengbrain.com/ws`

**注册请求参数:**

```json
{
    "status":"register",  # register，stop,process，reconnect，heartbeat
    "phone": "1293837467",
    "client_id":"1293837467_au12ggf12tygv"，
    "dataInfo":[[111,12,1],[],[]]
}
```

**参数说明:**

`status`: 连接类型 、( 注册，停止，发送数据，重新连接，心跳) ，除注册类型client_id为空，其他状态都需要发送client_id

`phone`: 用户电话号码

`client_id`:  唯一标识符

**功能说明**

+ register:  注册连接websocket，client_id，文件路径，时间等信息入库
+ process:  发送数据，调用算法接口，写入文件
+ reconnect：主要用于网络等特殊原因断开重新连接，复用client_id，保证数据写入统一
+ heartbeat： 发送心跳，确保连接状态每，目前设置为6分钟检测一次是否发送心跳
+ stop： 停止发送，断开连接，下一次重新连接走注册（）

**响应示例:**

```json
# register
{
    "code": 200,
    "msg": 1,
    "datainfo": {"Content":"初始化连接成功，可以发送数据","client_id": "12189739879_asdvhjjhg12",
        "csv_file": xxx.csv}
}
# process
{
    "code": 200,
    "msg": 1,
    "datainfo": {"Content":"数据已接收，正在写入CSV","sleep_stage": {"stage": ["Waking","Waking","Waking"], "stage_time": "10:50"},
        "status": "processing"}
}
# reconnect
{
    "code": 200,
    "msg": 1,
    "datainfo": {"Content": "重连成功，继续发送数据",
                "client_id": client_id,
                "csv_file": csv_path}
}
# heartbeat
{
    "code": 200,
    "msg": 1,
	datainfo={"Content": f"服务器收到{12189739879_asdvhjjhg12}设备心跳，已更改状态"}
}
# stop 发送两个信息

{
	"code": 200,
    "msg": 1, 
   "datainfo":{
	 "fall_sleep":"10:50", # 入睡时间
 	 "sleep_end":"10:50", # 睡眠结束时间
     "awake_minutes":24, # 清醒时长
     "wake_times_str":"10:50", # 醒来时间
    "deep_sleep_minutes":0,   # 深度睡眠时长
    "light_sleep_minutes":0, # 浅睡时长
    "all_during":24, # 总睡眠时间
    "rem_sleep_minutes":0, # 快速眼动
    "sleep_stage":[{"date":"10:50","predict_result":["Waking","Waking","Waking"]},{"date":"10:50","predict_result":["Waking","Waking","Waking"]}], # 睡眠分期数据
    "time_fall_sleep_diff":0, # 入睡时长差值
    "all_during_minutes_diff":24, # 总睡眠值差
    "light_sleep_minutes_diff":0, # 浅睡值差
    "deep_sleep_minutes_diff":0, # 深睡值差
    "wake_time_diff":0}  # 清醒时长值差
	"sleep_quality": 80，
	'wake_minutes_diff': -19, 
	'rem_minutes_diff': 0，
	'report_date': '2025-11-26'
	
      
}
```

**错误响应**

~~~
{
    "code":200,
    "msg":0,
    "datainfo":{
        "Content":xxx
    }
}
~~~

### 2. 首页睡眠报告

**接口地址:** `POST /api/v1/main/home_page`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{
    
}
```

**参数说明:**

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
	 "fall_sleep":"10:50", # 入睡时间
 	 "sleep_end":"10:50", # 睡眠结束时间
     "awake_minutes":24, # 清醒时长
     "wake_times_str":"10:50", # 醒来时间
    "deep_sleep_minutes":0,   # 深度睡眠时长
    "light_sleep_minutes":0, # 浅睡时长
    "all_during":24, # 总睡眠时间
    "rem_sleep_minutes":0, # 快速眼动
    "sleep_stage":[{"date":"10:50","predict_result":["Waking","Waking","Waking"]},{"date":"10:50","predict_result":["Waking","Waking","Waking"]}], # 睡眠分期数据
    "time_fall_sleep_diff":0, # 入睡时长差值
    "all_during_minutes_diff":24, # 总睡眠值差
    "light_sleep_minutes_diff":0, # 浅睡值差
    "deep_sleep_minutes_diff":0, # 深睡值差
    "wake_time_diff":0， # 清醒时长值差
	"sleep_quality":80，
	'wake_minutes_diff': -19, 
	'rem_minutes_diff': 0，
	'report_date': '2025-11-26'
}  

}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 3. 日期睡眠报告

**接口地址:** `POST /api/v1/sleep_algorithm/sleep_report`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{
   "sleep_start":"2025-11-24"， # 默认
	"sleep_start":"2025-11-24 17:20"
}
```

**参数说明:**

- `sleep_start`: 日期

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {'fall_sleep': '17:27', 
                 'sleep_end': '15:40', 
                 'awake_minutes': 27, 
                 'wake_times_str': '15:40', 
                 'deep_sleep_minutes': 0, 
                 'light_sleep_minutes': 0, 
                 'all_during': 27, 
                 'rem_sleep_minutes': 0, 
                 'sleep_stage': {'date': '17:27', 'predict_result': ['Waking', 'Waking', 'Waking']}, {'date': '17:27', 'predict_result': ['Waking', 'Waking', 'Waking']}], 
				'time_fall_sleep_diff': 0, 
				'all_during_minutes_diff': 6, 
				'light_sleep_minutes_diff': 0, 
                'deep_sleep_minutes_diff': 0, 
                'wake_time_diff': -92, 
                'sleep_quality': 10, 
                'wake_minutes_diff': 6, 
                'rem_minutes_diff': 0, 
                'report_date': '2025-11-24', 
                'status': 'stop', 
                'sleep_interpretation': None, 
                'today_sleep_start_list': ['17:27:36', '17:12:19', '15:20:18', '15:05:26']}}

	
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 4. 首页音乐列表

**接口地址:** `GET /api/v1/main/page_music`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{
   
}
```

**参数说明:**

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {"data": [{'type_name': '白噪音', 'musics': [{'mu_title': 'meditation_01', 'mu_path': 'http://127.0.0.1:9999/static/music/meditation_1.wav', 'mu_duration': 120, 'mu_picture': 'http://127.0.0.1:9999/static/images/01.png'},
		{'type_name': '风琴', 'musics': [{'mu_title': '古琴200.wav', 'mu_path': 'http://127.0.0.1:9999/static/music/古筝10.wav', 'mu_duration': 123, 'mu_picture': 'http://127.0.0.1:9999/static/images/03.png'}
                                                ]}
                 
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 5. 推荐音乐

**接口地址:** `GET /api/v1/sleep_algorithm/music_recommend`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{
   
}
```

**参数说明:**

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo":{'data': [{'mu_path': 'http://127.0.0.1:9999/static/music/meditation_1.wav', 'mu_type': 1, 'mu_type_name': '白噪音', 'mu_desc': '开启冥想后，助眠仪便化作一位沉静的旁观者备份', 'music_id': 1, 'mu_title': 'meditation_01', 'mu_picture': 'http://127.0.0.1:9999/static/images/01.png', 'collect_count': 1}, {'mu_path': 'http://127.0.0.1:9999/static/music/古筝10.wav', 'mu_type': 2, 'mu_type_name': '风琴', 'mu_desc': '开启冥想后，助眠仪便化作一位沉静的旁观者备份', 'music_id': 2, 'mu_title': '古琴200.wav', 'mu_picture': 'http://127.0.0.1:9999/static/images/03.png', 'collect_count': 2}]}}

                 
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

### 6. 根据音乐类别查询音乐

**接口地址:** `GET /api/v1/main/page_music`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**URL请求参数:**

```json
{
    "page": "1",
    "page_size": "10",
    "type_id": "1"
}
```

**参数说明:**

`type_id`: 类别id

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {'data': [{'id': 1, 'mu_title': 'meditation_01', 'mu_path': 'http://127.0.0.1:9999/static/music/meditation_1.wav', 'mu_duration': 120, 'mu_desc': '开启冥想后，助眠仪便化作一位沉静的旁观者备份', 'mu_picture': 'http://127.0.0.1:9999/static/images/01.png', 'mu_start': '', 'muscitype__id': 1, 'muscitype__type_name': '白噪音'}]}}

                 
}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f": {str(e)}"}
}
```

## 音乐模块

### 1.音乐推荐

**接口地址:** `POST /api/v1/main/page_music`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**请求参数:**

```json
{
  
}
```

**参数说明:**

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
        'data': [
            {'mu_path': 'http://127.0.0.1:9999/static/music/meditation_1.wav', 'mu_type': 1, 'mu_type_name': '白噪音', 'mu_desc': '开启冥想后，助眠仪便化作一位沉静的旁观者备份', 'music_id': 1, 'mu_title': 'meditation_01', 'mu_picture': 'http://127.0.0.1:9999/static/images/01.png', 'collect_count': 1}, 
            {'mu_path': 'http://127.0.0.1:9999/static/music/古筝10.wav', 'mu_type': 2, 'mu_type_name': '风琴', 'mu_desc': '开启冥想后，助眠仪便化作一位沉静的旁观者备份', 'music_id': 2, 'mu_title': '古琴200.wav', 'mu_picture': 'http://127.0.0.1:9999/static/images/03.png', 'collect_count': 2}]}}

}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"登录失败: {str(e)}"}
}
```

### 2.首页音乐列表

**接口地址:** `POST /api/v1/main/page_music`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**请求参数:**

```json
{
   "type":"error"，
   "content":"xxx",
   "image_path":["/xxx/sss/img.png","/xxx/sss.png"]
}
```

**参数说明:**

- `type`:  类型
- `content`: 内容
- `image_path`: 图片地址

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {'data': 
                 [
                  {'type_name': '白噪音', 'musics': [{'mu_title': 'meditation_01', 'mu_path': 'http://127.0.0.1:9999/static/music/meditation_1.wav', 'mu_duration': 120, 'mu_picture': 'http://127.0.0.1:9999/static/images/01.png'}]
                  }, 
                  {'type_name': '风琴', 'musics': [{'mu_title': '古琴200.wav', 'mu_path': 'http://127.0.0.1:9999/static/music/古筝10.wav', 'mu_duration': 123, 'mu_picture': 'http://127.0.0.1:9999/static/images/03.png'
                                                 }]}
                 ]}

}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"登录失败: {str(e)}"}
}
```

### 3.音乐类别列表

**接口地址:** `POST /api/v1/sleep_algorithm/category_music`

**请求头**：

```
{
    "Content-Type": "application/json",
    "Accept-Language":"zh-CN"，
    "X-Session-Id":"a33d1b5dbbdb444dbf9773f35499d4cf"
}
```

**请求参数:**

```json
{
   "type_id":"1"，
   
}
```

**参数说明:**

+ `type_id`：类别id

**响应示例:**

```json
{
    "code": 200,
    "msg": 1,
    "datainfo": {
        'data': [
    {
             'id': 1, 
             'mu_title': 'meditation_01', 
             'mu_path': 'http://127.0.0.1:9999/static/music/meditation_1.wav', 
             'mu_duration': 120, 
             'mu_desc': '开启冥想后，助眠仪便化作一位沉静的旁观者备份', 
             'mu_picture': 'http://127.0.0.1:9999/static/images/01.png', 
             'mu_start': '', 
             'muscitype__id': 1, 
             'muscitype__type_name': '白噪音'}]
    }

}
```

**错误响应:**

```json
{
    "code": 200,
    "msg": 0,
    "datainfo": {"Content":f"登录失败: {str(e)}"}
}
```

### 